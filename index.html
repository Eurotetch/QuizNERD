<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Configurator Quiz NERD</title>

  <style>
    :root{
      --nero:#120E01;
      --bianco:#F5F4F2;
      --giallo:#DCB339;
      --porpora:#691258;
      --card-bg: rgba(255,255,255,0.03);
      --muted: #cfc6a0;
    }
    /* reset e box-sizing */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--nero), #1b1408);color:var(--bianco);font-family:Inter, Arial, Helvetica, sans-serif}
    .wrap{max-width:1200px;margin:20px auto;padding:16px}
    header{display:flex;gap:12px;align-items:center}
    header img{height:56px}
    h1{margin:0;color:var(--giallo);font-size:1.4rem}
    .subtitle{color:var(--muted);font-size:0.95rem;margin-top:4px}

    /* layout: mobile-first stacked cards */
    .stack { display:flex; flex-direction:column; gap:14px; margin-top:16px; }
    .card { background:var(--card-bg); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); overflow:hidden; }
    label{display:block;font-weight:700;margin-bottom:6px;color:var(--bianco)}
    .list{max-height:300px;overflow:auto;padding:8px;border-radius:8px;background:rgba(0,0,0,0.12)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="file"]{color:var(--bianco)}
    input[type="number"]{width:100px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--bianco)}
    select, button{padding:8px 10px;border-radius:8px;border:none}
    button.primary{background:var(--giallo);color:var(--nero);font-weight:700}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--bianco)}
    .small{font-size:0.9rem;color:var(--muted)}
    .controls{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .footer-note{margin-top:12px;color:var(--muted);font-size:0.9rem}
    .chk{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px}

    /* preview container placed last on mobile */
    #previewContainer { order: 99; }

    /* desktop: two-column layout */
    @media(min-width:980px){
      .grid { display:grid; grid-template-columns:360px 1fr; gap:18px; align-items:start; }
      #previewContainer { order: 0; } /* preview normal order on desktop */
      .list{max-height:420px}
    }

    /* viewer */
    #viewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:9999}
    #slide{background:var(--bianco);color:var(--nero);width:92%;height:88%;border-radius:10px;padding:24px;overflow:auto}
    .viewer-controls{display:flex;gap:8px;justify-content:center;margin-top:12px}

    /* real-answer styling for page and PDF */
    .real-answer { background: var(--porpora); color: #fff; padding:4px 6px; border-radius:4px; display:inline-block; }

    /* ensure long category labels don't break layout */
    .cat-label { display:inline-block; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; vertical-align:middle; margin-left:8px; color:var(--bianco) }
  </style>

  <!-- Librerie -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="logo.png" alt="Logo" id="logo" onerror="this.style.display='none'"/>
      <div>
        <h1>Configurator Quiz NERD</h1>
        <div class="subtitle">Carica Excel, scegli filtri e genera PDF. Mobile‑first: tutte le card in colonna.</div>
      </div>
    </header>

    <div class="grid" style="margin-top:16px">
      <!-- left column (on desktop) / first cards (on mobile) -->
      <div class="stack">
        <div class="card">
          <label>Carica file Excel (.xlsx)</label>
          <div class="row">
            <button id="openFileBtn" class="ghost">Carica file Excel Domande</button>
            <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none" />
            <div style="margin-left:auto" class="small" id="statusArea">Nessun file caricato</div>
          </div>
        </div>

        <div class="card">
          <label>TIPOLOGIE DOMANDE</label>
          <div id="typesArea" class="list"></div>
          <div class="small" style="margin-top:8px">Seleziona le tipologie desiderate; le percentuali sono calcolate automaticamente.</div>
        </div>

        <div class="card">
          <label>CATEGORIE</label>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <label class="small"><input id="toggleAllCats" type="checkbox" /> Seleziona/Deseleziona tutte</label>
            <div style="margin-left:auto;display:flex;gap:6px">
              <button id="openPresetBtn" class="ghost">Importa preset</button>
              <input id="presetInput" type="file" accept=".txt" style="display:none" />
              <button id="exportPresetBtn" class="ghost">Esporta preset</button>
            </div>
          </div>
          <div id="catsArea" class="list"></div>
        </div>

        <div class="card">
          <label>DIFFICOLTÀ</label>
          <div class="row">
            <label class="chk"><input id="diff_all" type="checkbox" /> Tutte le difficoltà</label>
            <label class="chk"><input class="diffChk" data-diff="⭐" type="checkbox" /> Facili ★</label>
            <label class="chk"><input class="diffChk" data-diff="⭐⭐" type="checkbox" /> Medie ★★</label>
            <label class="chk"><input class="diffChk" data-diff="⭐⭐⭐" type="checkbox" /> Difficili ★★★</label>
            <label class="chk"><input class="diffChk" data-diff="⭐⭐⭐⭐" type="checkbox" /> Estreme ★★★★</label>
          </div>
        </div>

        <div class="card">
          <label>ORDINAMENTO</label>
          <div class="row">
            <select id="orderSelect">
              <option value="random">Ordine casuale</option>
              <option value="alpha_global">Ordine alfabetico globale</option>
              <option value="alpha_cat">Ordine alfabetico categoria per categoria</option>
              <option value="difficulty">Ordine di difficoltà</option>
            </select>
            <label class="chk" style="margin-left:8px"><input id="descCheckbox" type="checkbox" /> Decrescente</label>
          </div>
        </div>

        <div class="card">
          <div class="controls">
            <button id="previewBtn" class="ghost">Anteprima conteggi</button>
            <button id="exportBtn" class="primary">Esporta PDF</button>
            <button id="startGameBtn" class="ghost">Apri sessione di gioco</button>
            <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
              <label class="small">Totale Domande</label>
              <input id="totalInput" type="number" min="1" value="25" />
            </div>
          </div>
          <div id="previewArea" class="footer-note" style="margin-top:10px"></div>
        </div>
      </div>

      <!-- right column (on desktop) / preview last on mobile -->
      <div id="previewContainer" class="stack">
        <div class="card">
          <h3 style="margin:0;color:var(--giallo)">Istruzioni rapide</h3>
          <ul class="small" style="color:var(--muted);margin-top:8px">
            <li>Ogni foglio del file Excel è considerato una categoria.</li>
            <li>Intestazioni richieste: <strong>ID, Tema, Domanda, Tipologia, Risposta A..F, Difficoltà, Data Creazione</strong>.</li>
            <li>La risposta corretta può essere marcata con <strong>###</strong> nella cella corrispondente.</li>
            <li>Salva il file in UTF‑8 per evitare problemi con gli accenti.</li>
          </ul>
        </div>

        <div class="card">
          <h3 style="margin:0;color:var(--giallo)">Anteprima / Sessione di gioco</h3>
          <div class="small" style="margin-top:8px;color:var(--muted)">Dopo l'esportazione il viewer si aprirà automaticamente con le domande selezionate.</div>
          <div style="height:12px"></div>
          <div id="viewerStatus" class="small" style="color:var(--muted)">Nessuna sessione attiva</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Viewer (base) -->
  <div id="viewer">
    <div id="slide">
      <div id="slideContent"></div>
      <div class="viewer-controls">
        <button id="prevQ" class="ghost">Indietro</button>
        <button id="nextQ" class="ghost">Avanti</button>
        <button id="fsBtn" class="ghost">Schermo intero</button>
        <button id="closeViewer" class="ghost">Chiudi</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Stato e helper ---------- */
let workbookData = {}; // { sheetName: [rows] }
let allTypes = ['4 Risposte','6 Risposte','Vero/Falso','Frase interrotta a 2 risposte','Continua la risposta','Risposta aperta'];
let selectedQuestions = [];
let allCategories = [];

function norm(s){ return (s||'').toString().trim().toLowerCase(); }
function normalizeStars(s){ if(!s) return ''; return s.replace(/[\u2605\u2B50★☆✶✷✸✹✺✻✼✽✾✿]/g,'⭐').trim(); }
function countStars(s){ return (normalizeStars(s).match(/⭐/g)||[]).length; }
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* ---------- Inizializzazione sicura DOMContentLoaded ---------- */
document.addEventListener('DOMContentLoaded', () => {
  // elementi UI
  const openFileBtn = document.getElementById('openFileBtn');
  const fileInput = document.getElementById('fileInput');
  const typesArea = document.getElementById('typesArea');
  const catsArea = document.getElementById('catsArea');
  const previewArea = document.getElementById('previewArea');
  const statusArea = document.getElementById('statusArea');
  const previewBtn = document.getElementById('previewBtn');
  const exportBtn = document.getElementById('exportBtn');
  const startGameBtn = document.getElementById('startGameBtn');
  const applyPresetBtn = document.getElementById('openPresetBtn'); // button that opens file dialog
  const presetInput = document.getElementById('presetInput');
  const exportPresetBtn = document.getElementById('exportPresetBtn');
  const toggleAllCats = document.getElementById('toggleAllCats');
  const diffAllCheckbox = document.getElementById('diff_all');

  /* ---------- Build UI helpers ---------- */
  function buildTypesUI(){
    typesArea.innerHTML = '';
    allTypes.forEach(t => {
      const div = document.createElement('div');
      div.className = 'chk';
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.className = 'typeChk';
      input.dataset.type = t;
      input.checked = true;
      const label = document.createElement('label');
      label.appendChild(input);
      const span = document.createElement('span');
      span.textContent = ' ' + t;
      label.appendChild(span);
      div.appendChild(label);
      typesArea.appendChild(div);
    });
  }

  function buildCatsUI(){
    catsArea.innerHTML = '';
    allCategories.forEach(name => {
      const wrapper = document.createElement('div');
      wrapper.className = 'chk';

      const input = document.createElement('input');
      input.type = 'checkbox';
      input.className = 'catChk';
      input.dataset.cat = name; // full name stored safely
      input.checked = true;

      const label = document.createElement('label');
      label.appendChild(input);

      const labelText = document.createElement('span');
      labelText.className = 'cat-label';
      const maxLen = 48;
      labelText.textContent = (name.length > maxLen) ? (name.slice(0, maxLen-1) + '…') : name;
      labelText.title = name;

      label.appendChild(labelText);
      wrapper.appendChild(label);
      catsArea.appendChild(wrapper);
    });
    toggleAllCats.checked = Array.from(document.querySelectorAll('.catChk')).every(cb=>cb.checked);
  }

  /* ---------- File upload: single-step flow ---------- */
  openFileBtn.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', (ev) => {
    const f = ev.target.files[0];
    if (!f) return;
    loadExcelFile(f);
    fileInput.value = '';
  });

  /* ---------- Preset import/export (single-step) ---------- */
  applyPresetBtn.addEventListener('click', () => presetInput.click());

  presetInput.addEventListener('change', (ev) => {
    const f = ev.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const lines = e.target.result.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      document.querySelectorAll('.catChk').forEach(cb => cb.checked = false);
      lines.forEach(l => {
        document.querySelectorAll('.catChk').forEach(cb => {
          if (cb.dataset.cat === l) cb.checked = true;
        });
      });
      toggleAllCats.checked = Array.from(document.querySelectorAll('.catChk')).every(cb=>cb.checked);
      alert('Preset applicato');
    };
    reader.readAsText(f, 'utf-8');
    presetInput.value = '';
  });

  exportPresetBtn.addEventListener('click', () => {
    const selected = Array.from(document.querySelectorAll('.catChk')).filter(cb=>cb.checked).map(cb=>cb.dataset.cat);
    if (selected.length === 0) return alert('Nessuna categoria selezionata');
    const blob = new Blob([selected.join('\n')], {type:'text/plain;charset=utf-8'});
    saveAs(blob, `preset_categorie_${Date.now()}.txt`);
  });

  /* ---------- Toggle all categories ---------- */
  toggleAllCats.addEventListener('change', (e) => {
    const v = e.target.checked;
    document.querySelectorAll('.catChk').forEach(cb => cb.checked = v);
  });

  /* ---------- Difficoltà: sync "Tutte le difficoltà" with individual checkboxes ---------- */
  function setupDifficultySync(){
    const diffCheckboxes = Array.from(document.querySelectorAll('.diffChk'));
    diffAllCheckbox.addEventListener('change', (e) => {
      const checked = e.target.checked;
      diffCheckboxes.forEach(cb => cb.checked = checked);
    });
    diffCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        const allChecked = diffCheckboxes.every(d => d.checked);
        diffAllCheckbox.checked = allChecked;
      });
    });
  }
  setupDifficultySync();

  /* ---------- Excel parsing and load function ---------- */
  function loadExcelFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:'array'});
        workbookData = {}; allCategories = [];
        wb.SheetNames.forEach(name => {
          const ws = wb.Sheets[name];
          const json = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
          if (json.length < 2) return;
          const headers = json[0].map(h => String(h).trim());
          const rows = json.slice(1).map(r => {
            const obj = {};
            headers.forEach((h,i)=> obj[h] = r[i] ?? "");
            return obj;
          });
          const normalized = rows.map(r => ({
            ID: r['ID'] || r['Id'] || r['id'] || '',
            Tema: r['Tema'] || r['tema'] || name,
            Domanda: r['Domanda'] || r['Question'] || '',
            Tipologia: r['Tipologia'] || r['Type'] || '',
            RispostaA: r['Risposta A'] || r['RispostaA'] || r['A'] || '',
            RispostaB: r['Risposta B'] || r['RispostaB'] || r['B'] || '',
            RispostaC: r['Risposta C'] || r['RispostaC'] || r['C'] || '',
            RispostaD: r['Risposta D'] || r['RispostaD'] || r['D'] || '',
            RispostaE: r['Risposta E'] || r['RispostaE'] || r['E'] || '',
            RispostaF: r['Risposta F'] || r['RispostaF'] || r['F'] || '',
            Difficolta: r['Difficoltà'] || r['Difficolta'] || r['Difficulty'] || '',
            Data: r['Data Creazione'] || r['Data'] || r['Date'] || ''
          }));
          workbookData[name] = normalized;
          allCategories.push(name);
        });
        buildTypesUI();
        buildCatsUI();
        statusArea.innerText = `File caricato: ${Object.keys(workbookData).length} fogli`;
        previewArea.innerText = '';
        alert('File caricato. Fogli trovati: ' + Object.keys(workbookData).length);
      } catch(err){
        alert('Errore parsing Excel: ' + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  /* ---------- Filtri lettura ---------- */
  function getSelectedFilters(){
    const typeChecks = Array.from(document.querySelectorAll('.typeChk')).filter(i=>i.checked).map(i=>i.dataset.type);
    if(typeChecks.length === 0) throw new Error('Seleziona almeno una tipologia');
    const typePct = {}; typeChecks.forEach(t=>typePct[t]=1/typeChecks.length);

    const selectedCats = Array.from(document.querySelectorAll('.catChk')).filter(cb=>cb.checked).map(cb=>cb.dataset.cat);
    if(selectedCats.length === 0) throw new Error('Seleziona almeno una categoria');

    const allDiff = document.getElementById('diff_all').checked;
    const diffChecks = Array.from(document.querySelectorAll('.diffChk')).filter(i=>i.checked).map(i=>i.dataset.diff);
    const diffs = allDiff ? ['all'] : (diffChecks.length ? diffChecks : ['all']);

    const order = document.getElementById('orderSelect').value;
    const desc = document.getElementById('descCheckbox').checked;
    const totalN = Math.max(1, parseInt(document.getElementById('totalInput').value || 0));

    return { typePct, typeChecks, selectedCats, diffs, order, desc, totalN };
  }

  /* ---------- Pool e filtri ---------- */
  function filterPoolByDifficulty(pool, diffs){
    if(diffs.includes('all')) return pool;
    const wantedCounts = diffs.map(d => countStars(d));
    return pool.filter(q => {
      const qStars = countStars(q.Difficolta || "");
      return wantedCounts.includes(qStars);
    });
  }

  function buildPool(selectedCats, diffs){
    let pool = [];
    selectedCats.forEach(cat => {
      const arr = workbookData[cat] || [];
      const filtered = filterPoolByDifficulty(arr, diffs);
      filtered.forEach(q => {
        const copy = Object.assign({}, q);
        copy._category = cat;
        copy._normTipologia = norm(copy.Tipologia);
        copy._normCategory = norm(copy._category);
        pool.push(copy);
      });
    });
    return pool;
  }

  /* ---------- Allocazione e sampling ---------- */
  function allocateCounts(N, typePct, typeChecks, selectedCats, pool){
    const targetType = {};
    typeChecks.forEach(t => targetType[t] = Math.round(N * (typePct[t] || 0)));
    let sum = Object.values(targetType).reduce((a,b)=>a+b,0);
    while(sum !== N){
      const diff = N - sum;
      const key = typeChecks[Math.abs(diff) % typeChecks.length];
      targetType[key] += Math.sign(diff);
      sum = Object.values(targetType).reduce((a,b)=>a+b,0);
    }
    const perCellTargets = {};
    typeChecks.forEach(t => {
      perCellTargets[t] = {};
      const tNorm = norm(t);
      const poolType = pool.filter(q => q._normTipologia === tNorm);
      const countsByCat = {};
      selectedCats.forEach(c => {
        const cNorm = norm(c);
        countsByCat[c] = poolType.filter(q => q._normCategory === cNorm).length;
      });
      const totalAvailable = Object.values(countsByCat).reduce((a,b)=>a+b,0);
      if(totalAvailable === 0){
        selectedCats.forEach(c => perCellTargets[t][c] = 0);
      } else {
        selectedCats.forEach(c => perCellTargets[t][c] = Math.round(targetType[t] * (countsByCat[c] / totalAvailable)));
        let s = Object.values(perCellTargets[t]).reduce((a,b)=>a+b,0);
        while(s !== targetType[t]){
          const diff = targetType[t] - s;
          const cat = selectedCats[Math.abs(diff) % selectedCats.length];
          perCellTargets[t][cat] += Math.sign(diff);
          s = Object.values(perCellTargets[t]).reduce((a,b)=>a+b,0);
        }
      }
    });
    return { targetType, perCellTargets };
  }

  function sampleQuestions(perCellTargets, pool){
    const chosen = []; const usedIDs = new Set();
    for(const t of Object.keys(perCellTargets)){
      const tNorm = norm(t);
      for(const c of Object.keys(perCellTargets[t])){
        const need = perCellTargets[t][c];
        if(need <= 0) continue;
        const cNorm = norm(c);
        const candidates = pool.filter(q => q._normTipologia === tNorm && q._normCategory === cNorm && !usedIDs.has(q.ID));
        shuffleArray(candidates);
        const take = candidates.slice(0, need);
        take.forEach(q => { chosen.push(q); usedIDs.add(q.ID); });
      }
    }
    return { chosen, usedIDs };
  }

  function fillRemaining(N, chosen, pool, usedIDs){
    let remaining = N - chosen.length;
    if(remaining <= 0) return chosen;
    const candidates = pool.filter(q => !usedIDs.has(q.ID));
    shuffleArray(candidates);
    const take = candidates.slice(0, remaining);
    take.forEach(q => chosen.push(q));
    return chosen;
  }

  /* ---------- Anteprima conteggi ---------- */
  previewBtn.addEventListener('click', () => {
    try {
      const cfg = getSelectedFilters();
      const pool = buildPool(cfg.selectedCats, cfg.diffs);
      const alloc = allocateCounts(cfg.totalN, cfg.typePct, cfg.typeChecks, cfg.selectedCats, pool);
      previewArea.innerHTML = `
        Pool totale disponibile: <strong>${pool.length}</strong><br>
        Target per tipologia: <pre style="color:${'#e9e2c6'}">${JSON.stringify(alloc.targetType,null,2)}</pre>
        Target per cella (tipo x categoria): <pre style="color:${'#e9e2c6'}">${JSON.stringify(alloc.perCellTargets,null,2)}</pre>
      `;
    } catch(err){
      alert(err.message);
    }
  });

  /* ---------- Export PDF + open viewer ---------- */
  exportBtn.addEventListener('click', async () => {
    try {
      const cfg = getSelectedFilters();
      const pool = buildPool(cfg.selectedCats, cfg.diffs);
      if(pool.length === 0) return alert('Pool vuoto con i filtri selezionati');
      const alloc = allocateCounts(cfg.totalN, cfg.typePct, cfg.typeChecks, cfg.selectedCats, pool);
      let { chosen, usedIDs } = sampleQuestions(alloc.perCellTargets, pool);
      chosen = fillRemaining(cfg.totalN, chosen, pool, usedIDs);

      // ordering
      if(cfg.order === 'random') shuffleArray(chosen);
      else if(cfg.order === 'alpha_global') chosen.sort((a,b)=> (a.Domanda||'').localeCompare(b.Domanda||''));
      else if(cfg.order === 'alpha_cat') chosen.sort((a,b)=> a._category !== b._category ? a._category.localeCompare(b._category) : (a.Domanda||'').localeCompare(b.Domanda||''));
      else if(cfg.order === 'difficulty') chosen.sort((a,b)=> countStars(a.Difficolta||'') - countStars(b.Difficolta||''));
      if(cfg.desc) chosen.reverse();

      selectedQuestions = chosen.slice(0, cfg.totalN);

      await generatePdf(selectedQuestions, cfg);
      openViewer(selectedQuestions);
    } catch(err){
      alert(err.message);
    }
  });

  /* ---------- generatePdf (robusta) ---------- */
  async function generatePdf(questions, cfg){
    const container = document.createElement('div');
    container.id = '__pdf_export_container';
    container.style.width = '1200px';
    container.style.padding = '24px';
    container.style.fontFamily = 'Arial, Helvetica, sans-serif';
    container.style.color = '#111';
    container.style.background = '#fff';
    // visible but transparent so html2canvas can render
    container.style.position = 'absolute';
    container.style.left = '0';
    container.style.top = '0';
    container.style.opacity = '0';
    container.style.pointerEvents = 'none';
    container.style.zIndex = '99999';

    // inline style for real-answer to ensure rendering in PDF
    const styleInline = document.createElement('style');
    styleInline.innerHTML = `.real-answer{background:${'var(--porpora)'};color:#fff;padding:4px 6px;border-radius:4px;display:inline-block}`;
    container.appendChild(styleInline);

    const header = document.createElement('div');
    header.innerHTML = `<h1 style="margin:0;color:#120E01">Quiz esportato</h1>
      <div style="margin-top:6px">Totale domande: <strong>${questions.length}</strong></div>
      <div style="margin-top:6px">Filtri: Difficoltà=${cfg.diffs.join(',')}, Ordinamento=${cfg.order}, Decrescente=${cfg.desc}</div>
      <hr style="margin:12px 0">`;
    container.appendChild(header);

    questions.forEach((q, idx) => {
      const qDiv = document.createElement('div');
      qDiv.style.marginBottom = '12px';
      qDiv.innerHTML = `<div style="font-weight:700">${idx+1}. ${escapeHtml(q.Domanda)}</div>`;
      const answers = [q.RispostaA,q.RispostaB,q.RispostaC,q.RispostaD,q.RispostaE,q.RispostaF].map(s=> (s||'').trim()).filter(Boolean);
      if(answers.length){
        answers.forEach((a,i) => {
          const p = document.createElement('div');
          let text = a;
          if (text.includes('###')) {
            text = text.replace(/###/g, '').trim();
            p.classList.add('real-answer');
          }
          p.style.marginLeft = '12px';
          p.innerHTML = `<strong>${String.fromCharCode(65+i)})</strong> ${escapeHtml(text)}`;
          qDiv.appendChild(p);
        });
      } else {
        const p = document.createElement('div'); p.style.marginLeft='12px'; p.innerHTML = `<em>Risposta aperta</em>`; qDiv.appendChild(p);
      }
      const meta = document.createElement('div'); meta.style.marginTop='6px'; meta.style.color='#666'; meta.style.fontSize='12px';
      meta.innerText = `Categoria: ${q._category} • Tipologia: ${q.Tipologia} • Difficoltà: ${q.Difficolta}`;
      qDiv.appendChild(meta);
      container.appendChild(qDiv);
      const hr = document.createElement('hr'); hr.style.margin='8px 0'; container.appendChild(hr);
    });

    // appendice soluzioni
    const solHeader = document.createElement('div'); solHeader.innerHTML = `<h2>Appendice soluzioni</h2>`; container.appendChild(solHeader);
    questions.forEach((q, idx) => {
      const answersRaw = [q.RispostaA,q.RispostaB,q.RispostaC,q.RispostaD,q.RispostaE,q.RispostaF];
      let sol = "[non specificata]";
      for(let i=0;i<answersRaw.length;i++){ if((answersRaw[i]||'').includes('###')){ sol = String.fromCharCode(65+i); break; } }
      const p = document.createElement('div'); p.style.marginBottom='6px'; p.innerText = `${idx+1}. ${sol}`; container.appendChild(p);
    });

    document.body.appendChild(container);

    const opt = { margin:10, filename:`quiz_export_${Date.now()}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true,logging:false,allowTaint:false}, jsPDF:{unit:'pt',format:'a4',orientation:'portrait'} };
    try {
      if (!container.innerHTML || container.innerHTML.trim().length < 20) throw new Error('Container PDF vuoto prima della conversione');
      await html2pdf().set(opt).from(container).save();
    } catch(err){
      console.error('Errore generatePdf:', err);
      alert('Errore durante la generazione del PDF: ' + (err && err.message ? err.message : err));
    } finally {
      if (container && container.parentNode) container.parentNode.removeChild(container);
    }
  }

  /* ---------- Viewer base ---------- */
  let currentIndex = 0;
  function openViewer(questions){
    currentIndex = 0;
    document.getElementById('viewer').style.display = 'flex';
    renderSlide();
    document.getElementById('viewerStatus').innerText = `Sessione: ${questions.length} domande`;
  }
  function renderSlide(){
    const container = document.getElementById('slideContent');
    const q = selectedQuestions[currentIndex];
    const answers = [q.RispostaA,q.RispostaB,q.RispostaC,q.RispostaD,q.RispostaE,q.RispostaF].map(s=> (s||'').trim()).filter(Boolean);
    container.innerHTML = `<h2 style="margin:0 0 8px 0">Domanda ${currentIndex+1} / ${selectedQuestions.length}</h2>
      <h3 style="margin:0 0 12px 0">${escapeHtml(q.Domanda)}</h3>
      <div>${answers.length ? answers.map((a,i)=>{
        let text = a;
        let cls = '';
        if (text.includes('###')) { text = text.replace(/###/g,'').trim(); cls = 'real-answer'; }
        return `<div style="margin:6px 0"><strong>${String.fromCharCode(65+i)})</strong> <span class="${cls}">${escapeHtml(text)}</span></div>`;
      }).join('') : '<em>Risposta aperta</em>'}</div>
      <div style="margin-top:12px;color:#666">Categoria: ${escapeHtml(q._category)} • Tipologia: ${escapeHtml(q.Tipologia)} • Difficoltà: ${escapeHtml(q.Difficolta)}</div>`;
  }
  document.getElementById('nextQ').addEventListener('click', ()=>{ if(currentIndex < selectedQuestions.length-1) currentIndex++; renderSlide(); });
  document.getElementById('prevQ').addEventListener('click', ()=>{ if(currentIndex > 0) currentIndex--; renderSlide(); });
  document.getElementById('closeViewer').addEventListener('click', ()=>{ document.getElementById('viewer').style.display='none'; });

  /* ---------- Start session without export ---------- */
  startGameBtn.addEventListener('click', () => {
    try {
      const cfg = getSelectedFilters();
      const pool = buildPool(cfg.selectedCats, cfg.diffs);
      if(pool.length === 0) return alert('Pool vuoto con i filtri selezionati');
      shuffleArray(pool);
      selectedQuestions = pool.slice(0, cfg.totalN);
      openViewer(selectedQuestions);
    } catch(err){ alert(err.message); }
  });

}); // end DOMContentLoaded
</script>
</body>
</html>
